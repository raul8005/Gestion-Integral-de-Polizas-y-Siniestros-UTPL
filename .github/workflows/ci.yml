name: CI Pipeline

on:
  push:
    branches: [ main, develop, master ]
  pull_request:
    branches: [ main, develop, master ]

env:
  PYTHON_VERSION: '3.11'
  DJANGO_SETTINGS_MODULE: polizas.settings

jobs:
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential pkg-config libcairo2-dev

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black isort
          pip install -r requirements.txt

      - name: Run flake8
        run: |
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: Check code formatting with black
        run: black --check --diff .

      - name: Check import sorting with isort
        run: isort --check-only --diff .

  test:
    name: Run Tests
    runs-on: ubuntu-latest

    env:
      MINIO_ENDPOINT: http://127.0.0.1:9000
      MINIO_ACCESS_KEY: admin
      MINIO_SECRET_KEY: password123
      MINIO_BUCKET_NAME: expedientes-siniestros

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: UTPL2023
          MYSQL_DATABASE: polizas_test
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

      minio:
        image: minio/minio:latest
        env:
          MINIO_ROOT_USER: admin
          MINIO_ROOT_PASSWORD: password123
        ports:
          - 9000:9000
        # SE ELIMINÃ“: entrypoint y args que causaban errores de sintaxis o de Docker.
        # La imagen oficial ya sabe que debe ejecutar 'server /data' por defecto.

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y default-libmysqlclient-dev build-essential pkg-config libcairo2-dev

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-django pytest-cov awscli

      - name: Wait for MySQL
        run: |
          until mysqladmin ping -h 127.0.0.1 -u root -pUTPL2023 --silent; do
            echo "Waiting for MySQL..."
            sleep 2
          done

      - name: Wait for MinIO
        run: |
          until curl -f http://127.0.0.1:9000/minio/health/live; do
            echo "Waiting for MinIO..."
            sleep 2
          done

      - name: Create MinIO bucket
        run: |
          aws configure set aws_access_key_id admin
          aws configure set aws_secret_access_key password123
          aws --endpoint-url http://127.0.0.1:9000 s3 mb s3://expedientes-siniestros || true

      - name: Run migrations
        env:
          DATABASE_HOST: 127.0.0.1
          DATABASE_PORT: 3306
          DATABASE_NAME: polizas_test
          DATABASE_USER: root
          DATABASE_PASSWORD: UTPL2023
        run: |
          python manage.py makemigrations --check --dry-run
          python manage.py migrate

      - name: Run tests
        env:
          DATABASE_HOST: 127.0.0.1
          DATABASE_PORT: 3306
          DATABASE_NAME: polizas_test
          DATABASE_USER: root
          DATABASE_PASSWORD: UTPL2023
          AWS_ACCESS_KEY_ID: admin
          AWS_SECRET_ACCESS_KEY: password123
          AWS_STORAGE_BUCKET_NAME: expedientes-siniestros
          AWS_S3_ENDPOINT_URL: http://127.0.0.1:9000
        run: python manage.py test --verbosity=2

      - name: Generate coverage report
        run: pytest --cov=apppolizas --cov-report=xml --cov-report=html

      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          fail_ci_if_error: false

  security:
    name: Security Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install safety bandit
      - name: Check dependencies for vulnerabilities
        run: safety check --file requirements.txt || true
      - name: Run Bandit security linter
        run: |
          bandit -r . -f json -o bandit-report.json || true
          bandit -r . || true

  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: [lint, test]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: polizas-siniestros:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max